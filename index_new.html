<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Presenze Cantiere</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --color-primary:hsl(210,100%,40%);
      --color-primary-dark:hsl(210,100%,30%);
      --color-accent:hsl(140,60%,40%);
      --color-accent-dark:hsl(140,60%,30%);
      --color-warning:hsl(40,90%,60%);
      --color-text-dark:hsl(210,10%,20%);
      --color-text-light:hsl(210,5%,50%);
      --color-bg-light:hsl(210,20%,98%);
      --color-bg-alt:hsl(210,10%,95%);
      --color-border:hsl(210,15%,85%);
      --color-success-bg:hsl(140,60%,95%);
      --color-success-border:hsl(140,60%,75%);
      --color-warning-bg:hsl(40,90%,95%);
      --color-warning-border:hsl(40,90%,80%);
      --border-radius-base:8px;
      --shadow-light:0 1px 3px rgba(0,0,0,.05);
      --shadow-medium:0 4px 8px rgba(0,0,0,.1);
      --shadow-strong:0 8px 16px rgba(0,0,0,.15);
    }
    body{font-family:'Roboto',sans-serif;background:var(--color-bg-light);color:var(--color-text-dark);padding:20px;margin:0;box-sizing:border-box}
    .container{max-width:500px;margin:0 auto;padding:0 10px}
    h2,h3{text-align:center;color:var(--color-primary-dark);margin-bottom:20px}

    input,select,textarea,button{width:100%;padding:14px;margin:10px 0;font-size:16px;border:1px solid var(--color-border);border-radius:var(--border-radius-base);box-sizing:border-box;box-shadow:var(--shadow-light);min-height:48px}
    input:focus,select:focus,button:focus{outline:none;border-color:var(--color-primary);box-shadow:0 0 0 3px hsla(210,100%,40%,.2)}
    button{background:var(--color-primary);color:#fff;border:none;cursor:pointer;font-weight:bold;transition:background-color .3s ease,transform .2s ease,box-shadow .3s ease;box-shadow:var(--shadow-medium)}
    button:hover{background:var(--color-primary-dark);transform:translateY(-2px);box-shadow:var(--shadow-strong)}

    #form{margin-top:20px}
    #benvenuto{text-align:center;margin-bottom:20px;font-weight:bold;color:var(--color-text-dark);font-size:20px}
    #btnInvia{background:linear-gradient(to right,var(--color-accent),var(--color-accent-dark));font-size:18px;font-weight:bold;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.2)}
    #btnInvia:hover{background:linear-gradient(to right,var(--color-accent-dark),hsl(140,60%,25%));box-shadow:0 8px 16px rgba(0,0,0,.25)}
    .section-label{font-weight:bold;color:var(--color-text-dark);margin-top:15px;display:block;margin-bottom:5px}
    .card{background:#fff;padding:15px;border-radius:var(--border-radius-base);box-shadow:var(--shadow-medium);border:1px solid var(--color-border);margin-top:20px}

    #importaBox{background:var(--color-success-bg);padding:16px;border-radius:var(--border-radius-base);margin:10px 0;box-shadow:var(--shadow-light);border:1px solid var(--color-success-border)}
    #importaBox h4{margin:0 0 6px 0;color:var(--color-accent-dark);font-size:18px;font-weight:bold}
    #importaBox .sottotitolo{margin:0 0 12px 0;font-size:14px;color:var(--color-text-light)}

    #ultimaLavorazioneBox{background:#f0f7ff;padding:12px 15px;border:1px solid #cce0ff;border-radius:var(--border-radius-base);margin:15px 0;display:flex;align-items:center;gap:10px;box-shadow:var(--shadow-light)}
    #ultimaLavorazioneBox p{margin:0;font-size:14px;color:var(--color-text-light)}
    #ultimaLavorazioneBox strong{font-size:16px;color:var(--color-primary-dark)}
    #btnGestione{background:var(--color-primary);border-radius:10px;font-weight:bold}

    /* snackbar */
    #notifica{display:none;position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(50px) scale(.9);opacity:0;background:var(--color-accent);color:#fff;padding:16px 30px;border-radius:12px;box-shadow:0 8px 16px rgba(0,0,0,.3);font-size:18px;z-index:99999;transition:all .5s ease-out}
    #notifica.show{transform:translateX(-50%) translateY(0) scale(1);opacity:1}

    /* modale conferma invio */
    #modalConferma{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:9999;justify-content:center;align-items:center}
    #modalConferma>div{background:#fff;max-width:400px;width:90%;margin:auto;padding:25px;border-radius:12px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.2);position:relative;transform:scale(.9);opacity:0;transition:all .3s ease-out;box-sizing:border-box}
    #modalConferma.show>div{transform:scale(1);opacity:1}
    #riepilogoDati{background:var(--color-bg-alt);padding:15px;border-radius:var(--border-radius-base);border:1px solid var(--color-border);margin:15px 0;text-align:left;color:var(--color-text-dark);font-size:15px}
    #riepilogoDati ul{padding-left:15px;margin:0;list-style:none}
    #riepilogoDati li{margin-bottom:8px;line-height:1.4}
    #modalConferma button{padding:10px 25px;margin:0 8px;font-size:16px;border-radius:8px;box-shadow:var(--shadow-light)}
    #modalConferma button:first-of-type{background:var(--color-accent)}
    #modalConferma button:last-of-type{background:#ccc;color:var(--color-text-dark)}

    /* vecchio ‚ÄúRecentemente‚Äù -> nascosto */
    #ultimi7{display:none !important;}

    /* calendario */
    /* ======== CALENDARIO (stile pulito) ======== */
.cal-grid{
  display:grid;
  grid-template-columns:repeat(7,minmax(0,1fr));
  gap:10px;
}
.cal-weekday{
  font-weight:700;
  text-align:center;
  font-size:12px;
  color:var(--color-text-light);
  letter-spacing:.04em;
}
.cal-cell{
  background:#fff;
  border:1px solid var(--color-border);
  border-radius:12px;
  min-height:120px;
  padding:8px;
  position:relative;
  box-shadow:0 1px 2px rgba(0,0,0,.04);
  transition:box-shadow .2s ease;
}
.cal-cell:hover{ box-shadow:0 2px 8px rgba(0,0,0,.08); }
.cal-cell.oggi{ outline:2px solid var(--color-primary); outline-offset:1px; }
.cal-cell.sabato{ background:#fffdf7; }                 /* sabato leggero */
.cal-cell.domenica,.cal-cell.festivo{ background:#fff8f8; } /* domenica/festivo */
.cal-cell.fuori-mese{ background:var(--color-bg-alt); opacity:.6; }

.cal-day{
  position:absolute; top:8px; left:10px;
  font-weight:700; font-size:13px; color:var(--color-text-dark);
}

.cal-entries{
  margin-top:26px;
  display:flex; flex-direction:column; gap:6px;
  max-height:140px; overflow:auto; padding-right:2px;
}
/* üëá nasconde le scrollbar (quelle ‚Äúbarrette‚Äù) */
.cal-entries::-webkit-scrollbar{ width:0; height:0; }
.cal-entries{ scrollbar-width:none; -ms-overflow-style:none; }

.chip{
  background:#f7f9ff;
  border:1px solid var(--color-border);
  border-radius:10px;
  padding:6px 8px;
  line-height:1.2;
  cursor:pointer;
}
.chip .top{
  display:flex; justify-content:space-between; align-items:center;
  font-size:12px; font-weight:600; text-transform:uppercase; letter-spacing:.02em;
}
.chip .lav{
  font-size:12px; font-style:italic; color:var(--color-text-dark); opacity:.9;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.badge{
  font-size:11px; padding:2px 6px; border-radius:999px;
  border:1px solid var(--color-border); background:#fff;
}

.cal-empty{
  grid-column:1 / -1; text-align:center; color:var(--color-text-light); padding:10px 0;
}

@media(max-width:600px){
  .cal-cell{ min-height:110px; }
  .cal-entries{ max-height:120px; }
}

  </style>
</head>
<body>
  <div class="container">
    <datalist id="suggerimentiLavorazioni"></datalist>

    <div id="notifica"><strong>Dati inseriti correttamente</strong></div>

    <div id="benvenuto"><div id="messaggioBenvenuto"></div></div>

    <div id="login" class="card">
      <div style="display:flex;justify-content:center;gap:20px;margin-bottom:15px;">
        <a href="https://ferra2391.github.io/presenze-cantieri/index_EN.html"><img src="images/EN.png" alt="English" style="width:50px;height:auto"></a>
        <a href="https://ferra2391.github.io/presenze-cantieri/"><img src="images/IT.png" alt="Italiano" style="width:50px;height:auto"></a>
        <a href="https://ferra2391.github.io/presenze-cantieri/index_FR.html"><img src="images/FR.png" alt="Fran√ßais" style="width:50px;height:auto"></a>
      </div>
      <h2>üîê Login</h2>
      <input type="text" id="user" placeholder="üîë Utente">
      <input type="password" id="pass" placeholder="üîí Password">
      <button onclick="login()">üîì Accedi</button>
    </div>

    <div id="form" style="display:none;">
      <h3>üìÖ Compila Presenza</h3>

      <label class="section-label" for="data">Data:</label>
      <input type="date" id="data">

      <div style="display:flex;flex-wrap:wrap;gap:15px;margin-top:5px;">
        <div style="flex:1;">
          <label class="section-label" for="oreLavorate">üïí Ore lavorate:</label>
          <select id="oreLavorate">
            <option value="2">2</option><option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="6">6</option><option value="7">7</option>
            <option value="8" selected>8</option><option value="9">9</option><option value="10">10</option>
            <option value="11">11</option><option value="12">12</option>
          </select>
        </div>
        <div style="flex:1;">
          <label class="section-label" for="numeroCantieri">üèóÔ∏è Cantieri:</label>
          <select id="numeroCantieri" onchange="generaCampiCantieri()">
            <option value="1" selected>1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5">5</option>
          </select>
        </div>
      </div>

      <div id="cantieriMultipli"></div>

      <button id="btnMultiOperai" onclick="mostraOperai()">üëèüèº‚Äã Inserisci dati per altri operai</button>

      <div id="multiOperai" class="card" style="display:none;margin-top:20px;">
        <p class="warning-message">‚ö†Ô∏è Agli operai selezionati verranno applicate le stesse lavorazioni indicate sopra.</p>
        <label class="section-label" for="operaio">üë• Seleziona altri operai:</label>
        <select id="operaio" multiple size="6" onchange="gestisciMoltiplicatori()"></select>
        <div id="contenitoreMoltiplicatori" style="margin-top:15px;"></div>
        <div style="margin-top:15px;">
          <label class="section-label" for="nuovoOperaio">‚ûï Oppure inserisci un nuovo operaio:</label>
          <input type="text" id="nuovoOperaio" placeholder="üë∑ Inserisci nuovo operaio">
        </div>
      </div>

      <label class="section-label" for="note">üìù Note (facoltative):</label>
      <textarea id="note" class="lavorazione-autoresize" placeholder="Aggiungi eventuali note..." rows="1" oninput="autoResize(this)"></textarea>

      <button onclick="mostraModal()" id="btnInvia">üìÑ Invia Presenza</button>
      <button id="btnGestione" onclick="window.location.href='gestione.html'">üìÖ Vai alla Gestione Cantiere</button>

      <div id="ultimaLavorazioneBox">
        <span style="font-size:24px;color:var(--color-primary)">‚ú®</span>
        <div><p>La tua ultima lavorazione registrata:</p><strong id="ultimaLavorazione">Caricamento...</strong></div>
      </div>

      <!-- vecchio elenco: nascosto via CSS -->
      <div id="ultimi7" class="card"><h4>Recentemente:</h4></div>

      <!-- Calendario -->
      <div id="calMese" class="card" style="margin-top:16px;">
        <h4 id="calTitolo">Recentemente (...)</h4>
        <div class="cal-grid" id="calWeekHdr"></div>
        <div class="cal-grid" id="calGrid"></div>
      </div>

      <div id="overlay"></div>

      <!-- Modale modifica -->
      <div id="modalePresenza" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:1em;border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,.2);z-index:999;width:90%;max-width:400px">
        <h3>Modifica Presenza</h3>
        <form id="formModifica">
          <input type="hidden" id="mod_id">
          <label>Data: <input type="date" id="mod_data"></label><br><br>
          <label>Orari: <input type="text" id="mod_orari"></label><br><br>
          <label>Cantiere: <input type="text" id="mod_cantiere"></label><br><br>
          <label>Lavorazione: <input type="text" id="mod_lavorazione"></label><br><br>
          <label>Ore: <input type="number" id="mod_ore"></label><br><br>
          <label>Note: <textarea id="mod_note" rows="3"></textarea></label><br><br>
          <button type="button" onclick="inviaModifica()">üíæ Salva</button>
          <button type="button" onclick="chiudiModale()">‚ùå Annulla</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modale conferma invio -->
  <div id="modalConferma">
    <div>
      <p>Vuoi confermare l'invio della presenza?</p>
      <div id="riepilogoDati"></div>
      <button onclick="confermaInvio()">‚úÖ Conferma</button>
      <button onclick="chiudiModal()">‚ùå Annulla</button>
    </div>
  </div>

  <script>
    let utente="", nomeOperaio="", elencoCantieri=[], ruoliUtenti={}, ultimoTestoLavorazione="";

    function login(){
      const userInput=document.getElementById("user").value.trim();
      const passInput=document.getElementById("pass").value.trim();

      fetch("https://opensheet.elk.sh/1glvkWLOpUhdBUmY4j-2DJoXQvY6dnQD_OQkYYCaXXEQ/Utenti")
        .then(r=>r.json())
        .then(data=>{
          const u=data.find(r=>r["User"]===userInput && r["Password"]===passInput);
          if(!u){alert("Credenziali errate");return;}
          utente=u["User"]; nomeOperaio=u["Nome"];
          const ruolo=u["Ruolo"]||"";
          localStorage.setItem("ruolo",ruolo);
          document.getElementById("messaggioBenvenuto").innerText=`Benvenuto, ${nomeOperaio}`;
          if(ruolo.toLowerCase()!=="amministratore") document.getElementById("btnGestione").style.display="none";
          document.getElementById("login").style.display="none";
          document.getElementById("form").style.display="block";
          document.getElementById("data").value=new Date().toISOString().split("T")[0];

          caricaUltimaLavorazione(utente);
          caricaCantieri();
          caricaOperai();
          caricaRiepilogoAdmin();
          generaCampiCantieri();

          // üëâ carica subito il calendario
          caricaCalendarioMese();
        });
    }

    function caricaCantieri(){
      fetch("https://opensheet.elk.sh/1glvkWLOpUhdBUmY4j-2DJoXQvY6dnQD_OQkYYCaXXEQ/Cantieri")
        .then(r=>r.json())
        .then(data=>{
          elencoCantieri=data.filter(r=>r["Cantiere"]).map(r=>r["Cantiere"]);
          generaCampiCantieri();
        });
    }

    function caricaOperai(){
      fetch("https://opensheet.elk.sh/1glvkWLOpUhdBUmY4j-2DJoXQvY6dnQD_OQkYYCaXXEQ/Utenti")
        .then(r=>r.json())
        .then(data=>{
          const select=document.getElementById("operaio");
          select.innerHTML=""; ruoliUtenti={};
          data.forEach(r=>{
            if(r["Nome"]){
              const opt=document.createElement("option");
              opt.value=r["Nome"]; opt.textContent=r["Nome"]; select.appendChild(opt);
              ruoliUtenti[r["Nome"]]=r["Ruolo"]?.toUpperCase()||"OPERAIO";
            }
          });
        });
    }

    function mostraCantiereLibero(i){
      const div=document.getElementById(`cantiereLibero_${i}`);
      div.style.display=(div.style.display==="block")?"none":"block";
    }

    function generaCampiCantieri(){
      const n=parseInt(document.getElementById("numeroCantieri").value);
      const container=document.getElementById("cantieriMultipli");
      container.innerHTML="";
      for(let i=1;i<=n;i++){
        let sel=`<select id="cantiere_${i}"><option value="">-- Seleziona Cantiere --</option>`;
        elencoCantieri.forEach(nome=>sel+=`<option value="${nome}">${nome}</option>`); sel+=`</select>`;
        container.innerHTML+=`
          <div class="card" style="margin-top:15px;padding:15px;position:relative;">
            <label class="section-label" for="cantiere_${i}">üèóÔ∏è Cantiere ${i}:</label>
            ${sel}
            <button type="button" onclick="mostraCantiereLibero(${i})" id="btnCantiereAltro">üè† Clicca QUI se il cantiere non √® presente</button>
            <div id="cantiereLibero_${i}" style="display:none;">
              <input type="text" id="cantiereAltro_${i}" placeholder="üè¢ Inserisci nome cantiere ${i}">
            </div>
            <div id="importaBox">
              <h4>üíÖ‚Äã Lavorazioni eseguite per cantiere ${i}</h4>
              <p class="sottotitolo">üí° Scegli tra le lavorazioni recenti o scrivine una nuova:</p>
              <textarea id="lavorazione_${i}" class="lavorazione-autoresize" placeholder="üß†‚Äã Lavorazioni e suggerimenti" rows="1" oninput="autoResize(this); mostraSuggerimenti(this)" autocomplete="off"></textarea>
              <div class="suggerimenti-box" id="suggerimentiBox_${i}" style="display:none;"></div>
            </div>
          </div>`;
      }
      document.getElementById("btnMultiOperai").style.display=(n===1)?"inline-block":"none";
    }

    function mostraOperai(){const div=document.getElementById("multiOperai");div.style.display=(div.style.display==="block")?"none":"block";}

    function invia(){
      const n=parseInt(document.getElementById("numeroCantieri").value);
      const data=document.getElementById("data").value;
      const orari="08:00 - 17:00";
      const oreLavorate=parseInt(document.getElementById("oreLavorate").value)||8;
      const note=document.getElementById("note").value.trim();

      for(let i=1;i<=n;i++){
        let nomeCantiere=document.getElementById(`cantiere_${i}`)?.value||"";
        const altro=document.getElementById(`cantiereAltro_${i}`)?.value.trim()||"";
        if(altro) nomeCantiere=altro;
        const lavorazione=document.getElementById(`lavorazione_${i}`)?.value||"";
        if(!nomeCantiere||!lavorazione){alert(`‚ö†Ô∏è Devi compilare cantiere e lavorazione per la riga ${i}`);return;}

        const oreCalcolate=oreLavorate/n;
        let operai=[];
        if(document.getElementById("multiOperai").style.display==="block"){
          operai=Array.from(document.getElementById("operaio").selectedOptions).map(o=>o.value);
          const nuovo=document.getElementById("nuovoOperaio").value.trim(); if(nuovo) operai.push(nuovo);
          if(operai.length===0) operai=[nomeOperaio];
        }else{ operai=[nomeOperaio]; }

        operai.forEach(nome=>{
          const molId="moltiplicatore_"+nome.replace(/\s+/g,"_");
          const mol=parseInt(document.getElementById(molId)?.value)||1;
          for(let k=0;k<mol;k++){
            const body={data,orari,cantiere:nomeCantiere,lavorazione,ore:oreCalcolate,operaio:nome,user:utente,note};
            fetch("https://script.google.com/macros/s/AKfycbybSXuBklZxyoyvo-FvV-UZ280WBygR8wMRTAO97dl8h6_g8-_VjDtBa2uPrVOf2nmI6Q/exec",{method:"POST",mode:"no-cors",body:JSON.stringify(body),headers:{"Content-Type":"application/json"}});
          }
        });
      }
    }

    function caricaUltimaLavorazione(username){
      fetch(`https://script.google.com/macros/s/AKfycbybSXuBklZxyoyvo-FvV-UZ280WBygR8wMRTAO97dl8h6_g8-_VjDtBa2uPrVOf2nmI6Q/exec?getLastWork=1&username=${username}`)
        .then(r=>r.text())
        .then(txt=>{
          const el=document.getElementById("ultimaLavorazione");
          if(txt && txt.trim()!==""){el.textContent=txt; ultimoTestoLavorazione=txt;}
          else {el.textContent="(Nessuna lavorazione trovata)"; ultimoTestoLavorazione="";}
        });
    }

    function mostraModal(){
      const oreLavorate=parseInt(document.getElementById("oreLavorate").value)||8;
      const data=document.getElementById("data").value;
      let operai="";
      if(document.getElementById("multiOperai").style.display==="block"){
        const selezione=document.getElementById("operaio");
        const s=Array.from(selezione.selectedOptions).map(o=>o.value);
        const nuovo=document.getElementById("nuovoOperaio").value.trim(); if(nuovo) s.push(nuovo);
        operai=s.length>0?s.join(", "):nomeOperaio;
      }else{ operai=nomeOperaio; }

      const n=parseInt(document.getElementById("numeroCantieri").value);
      let dettagli="";
      for(let i=1;i<=n;i++){
        let cant=document.getElementById(`cantiere_${i}`)?.value||"(nessuno)";
        const altro=document.getElementById(`cantiereAltro_${i}`)?.value.trim()||"";
        if(altro) cant=altro;
        const lav=document.getElementById(`lavorazione_${i}`)?.value||"(nessuna)";
        dettagli+=`<li><strong>Cantiere ${i}:</strong> ${cant}<br><strong>Lavorazione:</strong> ${lav}</li>`;
      }
      document.getElementById("riepilogoDati").innerHTML=`<ul><li><strong>Data:</strong> ${data}</li><li><strong>Ore:</strong> ${oreLavorate}</li><li><strong>Operai:</strong> ${operai}</li><li><strong>Dettaglio Cantieri:</strong><ul>${dettagli}</ul></li></ul>`;
      document.getElementById("modalConferma").style.display="flex";
      document.getElementById("modalConferma").classList.add("show");
    }
    function chiudiModal(){document.getElementById("modalConferma").classList.remove("show");setTimeout(()=>{document.getElementById("modalConferma").style.display="none";},300);}
    function confermaInvio(){
      chiudiModal(); invia();

      const n=document.getElementById("notifica");
      n.style.display="block"; n.classList.add("show");
      setTimeout(()=>{n.classList.remove("show"); setTimeout(()=>{n.style.display="none";},500);},3500);

      document.getElementById("data").value=new Date().toISOString().split("T")[0];
      document.getElementById("oreLavorate").value="8";
      document.getElementById("numeroCantieri").value="1";
      document.getElementById("cantieriMultipli").innerHTML="";
      document.getElementById("multiOperai").style.display="none";
      document.getElementById("operaio").selectedIndex=-1;
      document.getElementById("nuovoOperaio").value="";
      document.getElementById("note").value="";
      generaCampiCantieri();
      caricaRiepilogoAdmin();

      // ricarico calendario dopo che GAS ha scritto/ordinato
      setTimeout(caricaCalendarioMese,1200);
    }

    function caricaRiepilogoAdmin(){
      const ruolo=localStorage.getItem("ruolo");
      if(ruolo && ruolo.toLowerCase()==="amministratore"){
        document.getElementById("riepilogoAdmin").style.display="block";
        const oggiISO=new Date().toISOString().split("T")[0];
        fetch("https://script.google.com/macros/s/AKfycbybSXuBklZxyoyvo-FvV-UZ280WBygR8wMRTAO97dl8h6_g8-_VjDtBa2uPrVOf2nmI6Q/exec?riepilogo=1&data="+oggiISO)
          .then(r=>r.json())
          .then(dati=>{
            const compilati=dati.compilati||[], mancanti=dati.mancanti||[];
            document.getElementById("riepilogoCompilati").innerHTML=`<h4>Compilati:</h4><ul>${compilati.map(op=>`<li>${op.nome} (${op.cantiere} - ${op.lavorazione})</li>`).join("")}</ul>`;
            document.getElementById("riepilogoMancanti").innerHTML=`<h4>Mancanti:</h4><ul>${mancanti.map(op=>`<li>${op}</li>`).join("")}</ul>`;
          });
      }
    }

    function autoResize(t){t.style.height="auto";t.style.height=t.scrollHeight+"px";}

    function mostraSuggerimenti(el){
      const index=el.id.split("_")[1];
      const box=document.getElementById("suggerimentiBox_"+index);
      const testo=el.value.toLowerCase();
      const s=window.lavorazioniRecenti||[];
      if(!testo||s.length===0){box.style.display="none";return;}
      const f=s.filter(x=>x.toLowerCase().includes(testo)).slice(0,10);
      if(f.length===0){box.style.display="none";return;}
      box.innerHTML="";
      f.forEach(val=>{
        const div=document.createElement("div");
        div.textContent=val; div.onclick=()=>{el.value=val; autoResize(el); box.style.display="none";};
        box.appendChild(div);
      });
      box.style.display="block";
    }

    function gestisciMoltiplicatori(){
      const c=document.getElementById("contenitoreMoltiplicatori"); c.innerHTML="";
      const selez=Array.from(document.getElementById("operaio").selectedOptions).map(o=>o.value);
      selez.forEach(nome=>{
        if(ruoliUtenti[nome]==="SUB"){
          const id="moltiplicatore_"+nome.replace(/\s+/g,"_");
          const b=document.createElement("div");
          b.style.marginBottom="10px";
          b.innerHTML=`<label style="font-weight:bold;">${nome} ‚Äì Quante persone considero per questa ditta?</label>
                       <input type="number" id="${id}" value="1" min="1" max="10" style="width:80px;margin-left:10px" />`;
          c.appendChild(b);
        }
      });
    }

    /* ==== Calendario ==== */
    function itMonthName(d){return d.toLocaleString('it-IT',{month:'long'}).replace(/^\w/,c=>c.toUpperCase());}
    function ymd(date){return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;}
    function buildWeekHeader(){
      const hdr=document.getElementById('calWeekHdr'); if(!hdr) return; hdr.innerHTML='';
      ['L','M','M','G','V','S','D'].forEach(g=>{const d=document.createElement('div'); d.className='cal-weekday'; d.textContent=g; hdr.appendChild(d);});
    }
    function calcEaster(Y){const a=Y%19,b=Math.floor(Y/100),c=Y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,L=(32+2*e+2*i-h-k)%7,m=Math.floor((a+11*h+22*L)/451),month=Math.floor((h+L-7*m+114)/31),day=((h+L-7*m+114)%31)+1;return new Date(Y,month-1,day);}
    function italianHolidays(year){
      const set=new Set(),add=(m,d)=>set.add(`${year}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`);
      add(1,1);add(1,6);add(4,25);add(5,1);add(6,2);add(8,15);add(11,1);add(12,8);add(12,25);add(12,26);
      const pasqua=calcEaster(year);const pasquetta=new Date(pasqua);pasquetta.setDate(pasqua.getDate()+1);
      add(pasqua.getMonth()+1,pasqua.getDate());add(pasquetta.getMonth()+1,pasquetta.getDate());return set;
    }

    function caricaCalendarioMese(){
      if(!nomeOperaio) return;
      const oggi=new Date(); const y=oggi.getFullYear(), m=oggi.getMonth()+1;
      const titolo=document.getElementById('calTitolo'); if(titolo) titolo.textContent=`Recentemente (${itMonthName(oggi)} ${y})`;
      buildWeekHeader();

      const url=`https://script.google.com/macros/s/AKfycbybSXuBklZxyoyvo-FvV-UZ280WBygR8wMRTAO97dl8h6_g8-_VjDtBa2uPrVOf2nmI6Q/exec?presenzeMese=1&opName=${encodeURIComponent(nomeOperaio)}&username=${encodeURIComponent(utente)}&year=${y}&month=${String(m).padStart(2,'0')}`;

      fetch(url).then(r=>r.json()).then(json=>{
        renderCalendario(json.presenze||[],y,m);
      }).catch(_=>{
        renderCalendario([],y,m);
      });
    }

    function renderCalendario(presenze, year, month){
  const grid = document.getElementById('calGrid'); if(!grid) return;
  grid.innerHTML = '';

  // Festivi IT
  const holidays = italianHolidays(year);

  // Raggruppo per giorno
  const byDay = {};
  presenze.forEach(p=>{
    const iso = p.dataISO || p.data || p.data_iso; 
    if(!iso) return;
    const dNum = +String(iso).split('-')[2];
    if(!byDay[dNum]) byDay[dNum] = [];
    byDay[dNum].push(p);
  });

  const first = new Date(year, month-1, 1);
  const last  = new Date(year, month, 0);
  const startOffset = (first.getDay()+6)%7;
  const daysInMonth = last.getDate();
  const totalCells  = Math.ceil((startOffset+daysInMonth)/7)*7;

  for(let i=0;i<totalCells;i++){
    const cell   = document.createElement('div'); 
    cell.className = 'cal-cell';

    const dayNum = i - startOffset + 1;
    const inMonth = dayNum>=1 && dayNum<=daysInMonth;
    if(!inMonth){
      cell.classList.add('fuori-mese');
      grid.appendChild(cell);
      continue;
    }

    const dateObj = new Date(year, month-1, dayNum);
    const dow     = (dateObj.getDay()+6)%7;
    if(dow===5) cell.classList.add('sabato');
    if(dow===6) cell.classList.add('domenica');

    const iso = `${year}-${String(month).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`;
    if(holidays.has(iso)) cell.classList.add('festivo');

    // oggi
    const todayISO = `${new Date().getFullYear()}-${String(new Date().getMonth()+1).padStart(2,'0')}-${String(new Date().getDate()).padStart(2,'0')}`;
    if(todayISO === iso) cell.classList.add('oggi');

    // numero giorno (clic se 1 sola presenza)
    const label = document.createElement('div');
    label.className = 'cal-day';
    label.textContent = String(dayNum).padStart(2,'0');

    const entries = byDay[dayNum] || [];
    if(entries.length===1){
      const onlyId = entries[0].id;
      label.addEventListener('click', ()=>{ if(onlyId) apriModifica(String(onlyId)); });
    }
    cell.appendChild(label);

    // contenitore presenze
    const wrap = document.createElement('div'); 
    wrap.className = 'cal-entries';

    entries.forEach(r=>{
      const e = document.createElement('div');
      e.className = 'cal-entry';
      e.setAttribute('title', (r.ore?`${r.ore}h ‚Äì `:'')+(r.cantiere||''));
      e.addEventListener('click', ()=>{ if(r.id) apriModifica(String(r.id)); });

      // üî∏ NUOVO LAYOUT "CHIP"
      e.innerHTML = `
        <div class="chip">
          <div class="top">
            <span>${(r.cantiere || '').toString().toUpperCase()}</span>
            <span class="badge">${r.ore ? (r.ore + ' h') : ''}</span>
          </div>
          <div class="lav">${r.lavorazione || ''}</div>
        </div>
      `;

      wrap.appendChild(e);
    });

    cell.appendChild(wrap);
    grid.appendChild(cell);
  }

  // messaggio quando non c'√® nulla
  if(Object.keys(byDay).length===0){
    const msg = document.createElement('div');
    msg.className = 'cal-empty';
    msg.textContent = 'Nessuna presenza nel mese';
    grid.appendChild(msg);
  }
}


    /* init: solo suggerimenti; il calendario parte dopo login */
    window.addEventListener("DOMContentLoaded",()=>{
      fetch("https://script.google.com/macros/s/AKfycbybSXuBklZxyoyvo-FvV-UZ280WBygR8wMRTAO97dl8h6_g8-_VjDtBa2uPrVOf2nmI6Q/exec?lavorazioniRecenti=1")
        .then(r=>r.json()).then(data=>{window.lavorazioniRecenti=data||[];});
    });

    /* modale modifica */
    function apriModifica(id){
      fetch(`https://script.google.com/macros/s/AKfycbybSXuBklZxyoyvo-FvV-UZ280WBygR8wMRTAO97dl8h6_g8-_VjDtBa2uPrVOf2nmI6Q/exec?getPresenza=1&id=${id}`)
        .then(res=>res.json())
        .then(dati=>{
          document.getElementById("mod_id").value=dati.id;
          document.getElementById("mod_data").value=(typeof dati.data==='string'? dati.data.split("T")[0] : new Date(dati.data).toISOString().split('T')[0]);
          document.getElementById("mod_orari").value=dati.orari||"";
          document.getElementById("mod_cantiere").value=dati.cantiere||"";
          document.getElementById("mod_lavorazione").value=dati.lavorazione||"";
          document.getElementById("mod_ore").value=dati.ore||"";
          document.getElementById("mod_note").value=dati.note||"";
          document.getElementById("overlay").style.display="block";
          document.getElementById("modalePresenza").style.display="block";
        });
    }
    function chiudiModale(){document.getElementById("overlay").style.display="none";document.getElementById("modalePresenza").style.display="none";}
    function inviaModifica(){
      const dati={modifica:1,id:document.getElementById("mod_id").value,data:document.getElementById("mod_data").value,orari:document.getElementById("mod_orari").value,cantiere:document.getElementById("mod_cantiere").value,lavorazione:document.getElementById("mod_lavorazione").value,ore:document.getElementById("mod_ore").value,note:document.getElementById("mod_note").value};
      fetch("https://script.google.com/macros/s/AKfycbybSXuBklZxyoyvo-FvV-UZ280WBygR8wMRTAO97dl8h6_g8-_VjDtBa2uPrVOf2nmI6Q/exec",{method:"POST",body:JSON.stringify(dati)})
        .then(res=>res.text())
        .then(_=>{
          alert("Modifica salvata!");
          chiudiModale();
          setTimeout(caricaCalendarioMese,500);
        });
    }
  </script>
</body>
</html>
