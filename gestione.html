<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Analisi Mensile Presenze</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary: hsl(210,100%,40%);
      --text: hsl(210,10%,20%);
      --muted: hsl(210,6%,45%);
      --bg: hsl(210,20%,98%);
      --card: #fff;
      --border: hsl(210,15%,85%);
      --orange-weak: hsla(30,100%,50%,0.08); /* festivi/weekend */
      --orange-weak-border: hsla(30,100%,50%,0.25);
      --danger: #c00000;
    }
    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
    }
    .container{
      width:100%; max-width:100%; margin:0; padding:18px 18px 32px;
    }
    h1{margin:0 0 12px; font-size:20px}
    .panel{
      background:var(--card); border:1px solid var(--border); border-radius:12px;
      padding:14px; box-shadow:0 2px 8px rgba(0,0,0,.04); margin-bottom:16px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    label{font-weight:600}
    input[type="month"],button{
      padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px; background:#fff;
    }
    button{background:var(--primary); color:#fff; border-color:transparent; cursor:pointer; font-weight:700}
    button:hover{filter:brightness(0.95)}
    .hint{color:var(--muted); font-size:12px; margin-top:6px}
    .legend{display:flex; gap:10px; align-items:center; color:var(--muted); font-size:12px}
    .pill{display:inline-block; height:12px; width:18px; border-radius:3px; background:var(--orange-weak); border:1px solid var(--orange-weak-border)}
    .spinner{display:none}
    .spinner.show{display:inline-block; width:16px; height:16px; border:2px solid #ddd; border-top-color:var(--primary); border-radius:50%; animation:spin .9s linear infinite; vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error{color:#b00020; font-weight:700}
    .ok{color:#0b7a0b; font-weight:700}

    /* stack verticale sempre */
    .matrix-stack{display:flex; flex-direction:column; gap:16px}

    .table-card{
      background:var(--card); border:1px solid var(--border); border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,.04); overflow:auto;
    }
    .table-title{padding:10px 12px; border-bottom:1px solid var(--border); font-weight:700}

    /* tavole a tutta larghezza con sticky header/first col */
    .table-wrap{width:100%; overflow:auto}
    table{border-collapse:separate; border-spacing:0; min-width:100%; font-size:12px}
    thead th{
      position:sticky; top:0; z-index:2; background:#fff; border-bottom:1px solid var(--border);
      padding:8px 6px; text-align:center; white-space:nowrap;
    }
    thead th.day-void{color:#aaa; background:#fafafa}
    thead th.weekend, thead th.festivo{background:var(--orange-weak); border-bottom-color:var(--orange-weak-border)}

    tbody th{
      position:sticky; left:0; z-index:1; background:#fff; border-right:1px solid var(--border);
      text-align:left; padding:8px 10px; font-size:12px; min-width:200px; /* più largo su desktop */
    }
    td{
      border-left:1px solid var(--border); border-top:1px solid var(--border);
      vertical-align:top; padding:6px; min-width:140px; max-width:320px; word-wrap:break-word;
    }
    tr:last-child td{border-bottom:1px solid var(--border)}

    tbody td.weekend, tbody td.festivo{background:var(--orange-weak)}
    td .entry{margin-bottom:6px}
    .cant{color:var(--danger); font-weight:800; text-transform:uppercase; letter-spacing:.02em}
    .ore{color:#111; font-weight:600}
    .note{color:var(--muted); font-style:italic}
    .tot{margin-top:4px; font-weight:800}
    .center{display:flex; align-items:center; justify-content:center}
  </style>
</head>
<body>
  <div class="container">
    <h1>Analisi mensile presenze</h1>

    <div class="panel">
      <div class="row">
        <label for="mese">Mese</label>
        <input type="month" id="mese">
        <button id="btnCarica">Carica</button>
        <span class="spinner" id="spin"></span>
      </div>
      <div class="row" style="margin-top:6px">
        <div class="legend">
          <span class="pill"></span> Sabato / Domenica / Festivi italiani
        </div>
        <div class="hint">Righe = Operai (Foglio1 col. C o fallback “Utenti”). Celle: CANTIERE (rosso) → ore → note; se più cantieri: “Tot: X h”.</div>
      </div>
      <div class="row" id="status" style="margin-top:6px"></div>
    </div>

    <div class="matrix-stack">
      <!-- Prima metà (1–15) -->
      <div class="table-card">
        <div class="table-title" id="titleA">Giorni 1–15</div>
        <div class="table-wrap">
          <table id="matrixA">
            <thead id="theadA"></thead>
            <tbody id="tbodyA"></tbody>
          </table>
        </div>
      </div>
      <!-- Seconda metà (16–31) -->
      <div class="table-card">
        <div class="table-title" id="titleB">Giorni 16–31</div>
        <div class="table-wrap">
          <table id="matrixB">
            <thead id="theadB"></thead>
            <tbody id="tbodyB"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
  // === Config ===
  const SHEET_ID = "1glvkWLOpUhdBUmY4j-2DJoXQvY6dnQD_OQkYYCaXXEQ";
  const URL_FOGLIO1 = `https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent("Foglio1")}`;
  const URL_UTENTI  = `https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent("Utenti")}`;

  // === Util ===
  const pad = n => String(n).padStart(2,"0");
  const normalize = s => String(s||"")
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .trim().toLowerCase();

  function parseDateAny(v){
    if(!v) return null;
    if(v instanceof Date) return v;
    const s = String(v).trim();
    if(/^\d{4}-\d{2}-\d{2}/.test(s)){ const [Y,M,D]=s.split("T")[0].split("-").map(Number); return new Date(Y,M-1,D); }
    if(/^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)){ const [d,m,y]=s.split(/[ /]/).map(Number); return new Date(y,m-1,d); }
    const t = new Date(s); return isNaN(t) ? null : t;
  }

  function calcEaster(Y){
    const a=Y%19,b=Math.floor(Y/100)
