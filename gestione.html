<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Analisi Mensile Presenze</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --primary: hsl(210,100%,40%);
      --text: hsl(210,10%,20%);
      --muted: hsl(210,6%,45%);
      --bg: hsl(210,20%,98%);
      --card: #fff;
      --border: hsl(210,15%,85%);
      --orange-weak: hsla(30,100%,50%,0.08); /* festivi/weekend */
      --orange-weak-border: hsla(30,100%,50%,0.25);
      --danger: #c00000;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .container{max-width:1200px;margin:0 auto;padding:18px}
    h1{margin:0 0 12px;font-size:20px}
    .panel{
      background:var(--card); border:1px solid var(--border); border-radius:12px;
      padding:14px; box-shadow:0 2px 8px rgba(0,0,0,.04); margin-bottom:14px;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-weight:600}
    input[type="month"],button{
      padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px; background:#fff;
    }
    button{
      background:var(--primary); color:#fff; border-color:transparent; cursor:pointer; font-weight:700;
    }
    button:hover{filter:brightness(0.95)}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}

    .table-wrap{
      border:1px solid var(--border); border-radius:12px; background:var(--card);
      overflow:auto; box-shadow:0 2px 8px rgba(0,0,0,.04);
    }
    table{border-collapse:separate;border-spacing:0;min-width:100%;font-size:12px}
    thead th{
      position:sticky; top:0; z-index:2; background:#fff; border-bottom:1px solid var(--border);
      padding:8px 6px; text-align:center; white-space:nowrap;
    }
    thead th.day-void{color:#aaa; background:#fafafa}
    tbody th{
      position:sticky; left:0; z-index:1; background:#fff; border-right:1px solid var(--border);
      text-align:left; padding:8px 10px; font-size:12px;
    }
    td{
      border-left:1px solid var(--border); border-top:1px solid var(--border);
      vertical-align:top; padding:6px; min-width:120px; max-width:220px; word-wrap:break-word;
    }
    tr:last-child td{border-bottom:1px solid var(--border)}
    td .entry{margin-bottom:6px}
    .cant{color:var(--danger); font-weight:800; text-transform:uppercase; letter-spacing:.02em}
    .ore{color:#111; font-weight:600}
    .note{color:var(--muted); font-style:italic}
    .tot{margin-top:4px; font-weight:800}
    .center{display:flex;align-items:center;justify-content:center}

    thead th.weekend, thead th.festivo{background:var(--orange-weak); border-bottom-color: var(--orange-weak-border)}
    tbody td.weekend, tbody td.festivo{background:var(--orange-weak)}

    .legend{display:flex;gap:10px;align-items:center;color:var(--muted);font-size:12px}
    .pill{display:inline-block; height:12px; width:18px; border-radius:3px; background:var(--orange-weak); border:1px solid var(--orange-weak-border)}
    .spinner{display:none}
    .spinner.show{display:inline-block; width:16px; height:16px; border:2px solid #ddd; border-top-color:var(--primary); border-radius:50%; animation:spin 0.9s linear infinite; vertical-align:-3px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error{color:#b00020; font-weight:700}
    .ok{color:#0b7a0b; font-weight:700}
  </style>
</head>
<body>
  <div class="container">
    <h1>Analisi mensile presenze</h1>

    <div class="panel">
      <div class="row">
        <label for="mese">Mese</label>
        <input type="month" id="mese">
        <button id="btnCarica">Carica</button>
        <span class="spinner" id="spin"></span>
      </div>
      <div class="row" style="margin-top:6px">
        <div class="legend">
          <span class="pill"></span> Sabato / Domenica / Festivi italiani
        </div>
        <div class="hint">Righe = operai, Colonne = giorni (1..31). Dati da Foglio1; se non trovati, fallback da “Utenti”.</div>
      </div>
      <div class="row" id="status" style="margin-top:6px"></div>
    </div>

    <div class="table-wrap">
      <table id="matrix">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

<script>
  // === Config ===
  const SHEET_ID = "1glvkWLOpUhdBUmY4j-2DJoXQvY6dnQD_OQkYYCaXXEQ";
  const URL_FOGLIO1 = `https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent("Foglio1")}`;
  const URL_UTENTI  = `https://opensheet.elk.sh/${SHEET_ID}/${encodeURIComponent("Utenti")}`;

  // === Util ===
  const pad = n => String(n).padStart(2,"0");

  const normalize = s => String(s||"")
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"") // rimuovi accenti
      .trim().toLowerCase();

  function parseDateAny(v){
    if(!v) return null;
    if(v instanceof Date) return v;
    const s = String(v).trim();
    if(/^\d{4}-\d{2}-\d{2}/.test(s)){ // ISO
      const [Y,M,D] = s.split("T")[0].split("-").map(Number);
      return new Date(Y, M-1, D);
    }
    if(/^\d{1,2}\/\d{1,2}\/\d{4}/.test(s)){ // IT
      const [d,m,y] = s.split(/[ /]/).map(Number);
      return new Date(y, m-1, d);
    }
    const t = new Date(s);
    return isNaN(t) ? null : t;
  }

  function calcEaster(Y){
    const a=Y%19,b=Math.floor(Y/100),c=Y%100,d=Math.floor(b/4),e=b%4,f=Math.floor((b+8)/25),
          g=Math.floor((b-f+1)/3),h=(19*a+b-d-g+15)%30,i=Math.floor(c/4),k=c%4,L=(32+2*e+2*i-h-k)%7,
          m=Math.floor((a+11*h+22*L)/451),month=Math.floor((h+L-7*m+114)/31),day=((h+L-7*m+114)%31)+1;
    return new Date(Y,month-1,day);
  }
  function italianHolidays(year){
    const set=new Set(),add=(m,d)=>set.add(`${year}-${pad(m)}-${pad(d)}`);
    add(1,1); add(1,6); add(4,25); add(5,1); add(6,2); add(8,15); add(11,1); add(12,8); add(12,25); add(12,26);
    const p=calcEaster(year), q=new Date(p); q.setDate(p.getDate()+1);
    add(p.getMonth()+1,p.getDate()); add(q.getMonth()+1,q.getDate());
    return set;
  }

  // Prende un campo con nomi robusti: prova exact, poi cerca per “somiglianza”
  function getFieldSmart(row, candidates){
    // exact (case sensitive)
    for(const k of candidates){
      if(row.hasOwnProperty(k) && row[k] != null && row[k] !== "") return row[k];
    }
    // exact (case insensitive e trim accents)
    const keys = Object.keys(row);
    const normMap = new Map(keys.map(k => [normalize(k), k]));
    for(const cand of candidates){
      const n = normalize(cand);
      if(normMap.has(n)){
        const realKey = normMap.get(n);
        if(row[realKey] != null && row[realKey] !== "") return row[realKey];
      }
    }
    // contains “operaio”, “data”, “cantiere”, “ore”, “note” ecc.
    const targets = candidates.map(normalize);
    for(const k of keys){
      const nk = normalize(k);
      if(targets.some(t => nk.includes(normalize(t)))){
        if(row[k] != null && row[k] !== "") return row[k];
      }
    }
    // fallback colonne letterali
    for(const k of candidates){
      if(row[k] != null && row[k] !== "") return row[k];
    }
    return "";
  }

  // === Header giorni ===
  function renderHeader(year, month){
    const thead = document.getElementById("thead");
    thead.innerHTML = "";
    const tr = document.createElement("tr");

    const th0 = document.createElement("th");
    th0.textContent = "Operaio";
    th0.style.minWidth = "160px";
    th0.style.textAlign = "left";
    tr.appendChild(th0);

    const daysInMonth = new Date(year, month, 0).getDate();
    const holidays = italianHolidays(year);

    for(let d=1; d<=31; d++){
      const th = document.createElement("th");
      th.textContent = d;
      th.style.minWidth = "140px";
      th.title = `${pad(d)}/${pad(month)}/${year}`;
      if(d > daysInMonth){
        th.classList.add("day-void");
      }else{
        const dow = (new Date(year, month-1, d).getDay()+6)%7; // 0=Lun
        const iso = `${year}-${pad(month)}-${pad(d)}`;
        if(dow===5 || dow===6) th.classList.add("weekend");
        if(holidays.has(iso)) th.classList.add("festivo");
      }
      tr.appendChild(th);
    }
    thead.appendChild(tr);
  }

  // === Corpo tabella ===
  function renderBody(year, month, dataRows, fallbackNames){
    const tbody = document.getElementById("tbody");
    tbody.innerHTML = "";

    // 1) Operai da Foglio1 (robusto) oppure fallback da Utenti
    const setFromFoglio = new Set();
    dataRows.forEach(r=>{
      const op = String(getFieldSmart(r, ["Operaio","C","OPERAIO","operaio"])).trim();
      if(op) setFromFoglio.add(op);
    });

    let operai = Array.from(setFromFoglio);
    if(operai.length === 0 && fallbackNames && fallbackNames.length){
      operai = fallbackNames.slice(); // da Utenti
    }
    operai.sort((a,b)=>a.localeCompare(b,'it'));

    // 2) Filtra righe del mese e raggruppa per operaio->giorno
    const byOpDay = {}; // { [op]: { [d]: [ {cantiere, ore, note} ] } }
    const daysInMonth = new Date(year, month, 0).getDate();

    dataRows.forEach(r=>{
      const dataVal = getFieldSmart(r, ["Data","A","DATA","data"]);
      const dt = parseDateAny(dataVal);
      if(!dt) return;
      if(dt.getFullYear()!==year || (dt.getMonth()+1)!==month) return;

      const op = String(getFieldSmart(r, ["Operaio","C","OPERAIO","operaio"])).trim();
      if(!op) return;
      const d = dt.getDate();

      const cantiere = String(getFieldSmart(r, ["Cantiere","E","CANTIERE","cantiere"])).trim();
      const oreRaw = getFieldSmart(r, ["Ore","H","ORE","ore"]);
      const ore = (oreRaw!=="" && oreRaw!=null) ? Number(String(oreRaw).replace(",",".")) : null;
      const note = String(getFieldSmart(r, ["Note","I","NOTE","note"])).trim();

      byOpDay[op] ??= {};
      byOpDay[op][d] ??= [];
      byOpDay[op][d].push({cantiere, ore, note});
    });

    // 3) Render
    const holidays = italianHolidays(year);

    if(operai.length === 0){
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 1 + 31;
      td.className = "center";
      td.style.padding = "24px";
      td.innerHTML = `<span class="error">Nessun operaio trovato (né in Foglio1 né in Utenti).</span>`;
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    operai.forEach(op=>{
      const tr = document.createElement("tr");

      const th = document.createElement("th");
      th.textContent = op;
      tr.appendChild(th);

      for(let d=1; d<=31; d++){
        const td = document.createElement("td");

        if(d <= daysInMonth){
          const dow = (new Date(year, month-1, d).getDay()+6)%7;
          const iso = `${year}-${pad(month)}-${pad(d)}`;
          if(dow===5 || dow===6) td.classList.add("weekend");
          if(holidays.has(iso)) td.classList.add("festivo");

          const entries = (byOpDay[op] && byOpDay[op][d]) ? byOpDay[op][d] : [];

          if(entries.length){
            let total = 0;
            entries.forEach(en=>{
              const wrap = document.createElement("div");
              wrap.className = "entry";
              const cant = en.cantiere ? en.cantiere.toUpperCase() : "(SENZA CANTIERE)";
              const oreTxt = (en.ore!=null && !isNaN(en.ore)) ? `${en.ore} h` : "";
              const note   = en.note ? en.note : "";

              wrap.innerHTML =
                `<div class="cant">${cant}</div>
                 <div class="ore">${oreTxt}</div>` +
                (note ? `<div class="note">${note}</div>` : "");

              td.appendChild(wrap);
              if(en.ore!=null && !isNaN(en.ore)) total += Number(en.ore);
            });
            if(entries.length>1){
              const tot = document.createElement("div");
              tot.className = "tot";
              tot.textContent = `Tot: ${(+total.toFixed(2)).toString()} h`;
              td.appendChild(tot);
            }
          }else{
            td.innerHTML = `<div class="center" style="min-height:30px;color:#bbb">—</div>`;
          }

        }else{
          td.style.background = "#fafafa";
        }
        tr.appendChild(td);
      }

      tbody.appendChild(tr);
    });
  }

  // === Caricamento + UI ===
  const meseInput = document.getElementById("mese");
  const btn       = document.getElementById("btnCarica");
  const spin      = document.getElementById("spin");
  const statusEl  = document.getElementById("status");

  function setLoading(on){
    spin.classList.toggle("show", !!on);
    btn.disabled = !!on;
  }

  async function carica(){
    try{
      setLoading(true);
      statusEl.textContent = "";
      const ym = meseInput.value; // "YYYY-MM"
      if(!ym){ statusEl.innerHTML = `<span class="error">Seleziona un mese.</span>`; return; }
      const [Y,M] = ym.split("-").map(Number);

      // 1) leggo Foglio1
      const res = await fetch(URL_FOGLIO1);
      const rows = await res.json();

      // 2) leggo Utenti (fallback nomi)
      let fallbackNomi = [];
      try {
        const ures = await fetch(URL_UTENTI);
        const utenti = await ures.json();
        fallbackNomi = utenti
          .map(r => (r["Nome"] || r["nome"] || "").toString().trim())
          .filter(Boolean)
          .sort((a,b)=>a.localeCompare(b,'it'));
      } catch { /* opzionale */ }

      renderHeader(Y, M);
      renderBody(Y, M, rows, fallbackNomi);

      const nRows = Array.isArray(rows)? rows.length : 0;
      statusEl.innerHTML = `<span class="ok">Dati caricati (${nRows} righe da Foglio1)</span>`;
    }catch(err){
      console.error(err);
      statusEl.innerHTML = `<span class="error">Errore nel caricamento dati.</span>`;
    }finally{
      setLoading(false);
    }
  }

  (function init(){
    const now = new Date();
    meseInput.value = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
    carica();
    btn.addEventListener("click", carica);
  })();
</script>
</body>
</html>
